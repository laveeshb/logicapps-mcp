openapi: 3.0.3
info:
  title: Logic Apps Assistant API
  description: API for managing and troubleshooting Azure Logic Apps workflows
  version: 1.0.0

servers:
  - url: https://{functionAppName}.azurewebsites.net/api
    description: Azure Function App
    variables:
      functionAppName:
        default: la-6lxbp4hq-agent
        description: The Azure Function App name

security:
  - bearerAuth: []

paths:
  /copilot/auth-test:
    get:
      operationId: testAuthentication
      summary: Test authentication and list subscriptions
      description: Tests whether user token or managed identity works for ARM API calls. Returns list of Azure subscriptions as proof of successful authentication.
      responses:
        '200':
          description: Authentication test results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTestResult'
        '500':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTestResult'

  /copilot/subscriptions:
    get:
      operationId: listSubscriptions
      summary: List Azure subscriptions
      description: Returns all Azure subscriptions accessible to the authenticated user or managed identity.
      responses:
        '200':
          description: List of subscriptions
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscriptions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Subscription'

  /copilot/logic-apps:
    get:
      operationId: listLogicApps
      summary: List Logic Apps in a subscription
      description: Returns all Logic Apps (Standard and Consumption) in the specified subscription.
      parameters:
        - name: subscriptionId
          in: query
          required: true
          description: Azure subscription ID
          schema:
            type: string
      responses:
        '200':
          description: List of Logic Apps
          content:
            application/json:
              schema:
                type: object
                properties:
                  logicApps:
                    type: array
                    items:
                      $ref: '#/components/schemas/LogicApp'

  /copilot/failed-runs:
    get:
      operationId: getFailedRuns
      summary: Get failed workflow runs
      description: Returns recent failed runs for a Logic App workflow.
      parameters:
        - name: subscriptionId
          in: query
          required: true
          schema:
            type: string
        - name: resourceGroup
          in: query
          required: true
          schema:
            type: string
        - name: logicAppName
          in: query
          required: true
          schema:
            type: string
        - name: workflowName
          in: query
          required: false
          description: For Standard Logic Apps, specify the workflow name
          schema:
            type: string
        - name: hours
          in: query
          required: false
          description: Number of hours to look back (default 24)
          schema:
            type: integer
            default: 24
      responses:
        '200':
          description: List of failed runs
          content:
            application/json:
              schema:
                type: object
                properties:
                  failedRuns:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkflowRun'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: Bearer token for authentication (user token from Copilot or API key)

  schemas:
    AuthTestResult:
      type: object
      properties:
        method:
          type: string
          enum: [user_token, managed_identity, none]
          description: Which authentication method was used
        success:
          type: boolean
          description: Whether authentication succeeded
        subscriptions:
          type: array
          items:
            $ref: '#/components/schemas/Subscription'
        error:
          type: string
          description: Error message if authentication failed

    Subscription:
      type: object
      properties:
        id:
          type: string
          description: Subscription ID
        displayName:
          type: string
          description: Subscription display name

    LogicApp:
      type: object
      properties:
        id:
          type: string
          description: Resource ID
        name:
          type: string
          description: Logic App name
        type:
          type: string
          enum: [Standard, Consumption]
        resourceGroup:
          type: string
        location:
          type: string
        state:
          type: string

    WorkflowRun:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        status:
          type: string
        startTime:
          type: string
          format: date-time
        endTime:
          type: string
          format: date-time
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
